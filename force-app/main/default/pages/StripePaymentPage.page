<apex:page controller="StripePaymentController" showHeader="false" sidebar="false" docType="html-5.0">
    <html>
        <head>
            <script src="https://js.stripe.com/v3/"></script>
            <style>
                body {
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial;
                    background: #f7f9fb;
                    padding: 30px;
                }

                .container {
                    max-width: 420px;
                    margin: auto;
                    background: #fff;
                    padding: 24px;
                    border-radius: 10px;
                    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
                }

                h2 {
                    margin-bottom: 10px;
                }

                .amount-display {
                    font-size: 28px;
                    font-weight: bold;
                    border-bottom: 4px solid #eee;
                    padding: 10px 0;
                    margin-bottom: 20px;
                    display: flex;
                    align-items: center;
                }

                .amount-display span {
                    margin-right: 2px;
                }

                .amount-display input {
                    font-size: 30px;
                    font-weight: bold;
                    border: none;
                    outline: none;
                    width: 100%;
                    padding-top: 5px;
                }

                /* Chrome, Safari, Edge, Opera */
                #amount::-webkit-outer-spin-button,
                #amount::-webkit-inner-spin-button {
                    -webkit-appearance: none;
                    margin: 0;
                }

                /* Firefox */
                input[type="number"] {
                    -moz-appearance: textfield;
                }

                label {
                    font-weight: 600;
                    font-size: 13px;
                    margin-top: 15px;
                    display: block;
                }

                .section {
                    margin-top: 20px;
                }

                #card-element {
                    border: 1px solid #dcdcdc;
                    padding: 12px;
                    border-radius: 6px;
                    margin-top: 8px;
                }

                .payBtn {
                    width: 100%;
                    padding: 14px;
                    background: #635bff;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    font-size: 15px;
                    cursor: pointer;
                    margin-top: 25px;
                    transition: background 0.3s ease;
                }

                .payBtn:hover {
                    background: #4e45e5;
                }

                .payBtn:disabled {
                    background: #a5a5a5;
                    cursor: not-allowed;
                }

                .error {
                    color: #c23934;
                    margin-top: 12px;
                    font-size: 14px;

                    /*background-color: #b14945;
                    border-radius: 4px;
                    color: #fff;
                    margin-top: 18px;
                    padding: 4px 6px;
                    font-size: 14px;*/
                }

                .success {
                    font-size: 12px;
                    text-align: center;
                    color: #2e844a;
                }

                .success h2 {
                    color: #2e844a;
                    font-size: 18px;
                }

                .spinner {
                    display: none;
                    text-align: center;
                    margin-top: 20px;
                }

                .spinner.show {
                    display: block;
                }
            </style>
        </head>

        <body>
            <div class="container">
                <!-- PAID STATE -->
                <apex:outputPanel rendered="{!amountDue == 0}">
                    <div class="success">
                        <h2>Invoice Paid</h2>
                        <p>This invoice has already been paid.</p>
                    </div>
                </apex:outputPanel>

                <!-- PAYMENT STATE -->
                <apex:outputPanel rendered="{!amountDue > 0}">
                    <div id="payment">
                        <h2>Make a Payment</h2>

                        <div class="amount-display">
                            <span>$</span>
                            <input id="amount" type="number" value="{!amountDue}" min="1" max="{!amountDue}" />
                        </div>

                        <!-- <div class="section">
                            <label>Billing Details</label>
                            <input type="text" placeholder="Name" disabled />
                            <input type="email" placeholder="Email" disabled />
                        </div> -->

                        <div class="section">
                            <label>Payment Method</label>
                            <div id="card-element"></div>
                        </div>

                        <button id="payBtn" class="payBtn" onclick="pay()">Pay</button>

                        <div class="spinner" id="spinner">Processing paymentâ€¦</div>
                        <div id="error" class="error"></div>
                    </div>
                </apex:outputPanel>
            </div>

            <script>
                const stripe = Stripe("{!publishableKey}");
                const elements = stripe.elements();
                const card = elements.create("card");
                card.mount("#card-element");

                let paymentInProgress = false;

                function setLoading(state) {
                    document.getElementById("payBtn").disabled = state;
                    document.getElementById("spinner").classList.toggle("show", state);
                }

                function pay() {
                    if (paymentInProgress) return;

                    const amount = document.getElementById("amount").value;
                    const errorEl = document.getElementById("error");
                    const paymentEl = document.getElementById("payment");

                    errorEl.textContent = "";

                    if (!amount || amount <= 0) {
                        errorEl.textContent = "Please enter a valid amount.";
                        return;
                    } else if (amount > '{!amountDue}') {
                        errorEl.textContent = "Amount exceeds the total due.";
                        return;
                    }

                    paymentInProgress = true;
                    setLoading(true);

                    Visualforce.remoting.Manager.invokeAction(
                        "{!$RemoteAction.StripePaymentController.createPaymentIntent}",
                        "{!invoiceId}",
                        amount,
                        function (result, event) {
                            if (event.status) {
                                stripe
                                    .confirmCardPayment(result.clientSecret, {
                                        payment_method: {
                                            card: card
                                        }
                                    })
                                    .then(function (res) {
                                        if (res.error) {
                                            errorEl.textContent = res.error.message;
                                            paymentInProgress = false;
                                            setLoading(false);
                                        } else {
                                            if (res.paymentIntent.status === "succeeded") {
                                                paymentEl.innerHTML =
                                                    '<div class="success">' +
                                                    "<h2>Payment Successful</h2>" +
                                                    "<p>Thank you. Your payment has been received.</p>" +
                                                    "</div>";
                                            }
                                        }
                                    });
                            } else {
                                errorEl.textContent = result ? result.errorMessage : event.message;
                                paymentInProgress = false;
                                setLoading(false);
                            }
                        }
                    );
                }
            </script>
        </body>
    </html>
</apex:page>